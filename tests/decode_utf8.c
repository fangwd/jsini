#include "jsini.h"

#include <stdint.h>
#include <stdio.h>

typedef struct {
    int32_t ch;
    int32_t len;
    char buf[4];
} test_case;

test_case cases[] = {
    { 0x24,     1, { 0x24, 0x00, 0x00, 0x00 } },
    { 0x7f,     1, { 0x7f, 0x00, 0x00, 0x00 } },
    { 0x80,      2, { 0xc2, 0x80, 0x00, 0x00 } },
    { 0x80,     -1, { 0xc2, 0x7f, 0x00, 0x00 } },
    { 0xa2,      2, { 0xc2, 0xa2, 0x00, 0x00 } },
    { 0x7ff,     2, { 0xdf, 0xbf, 0x00, 0x00 } },
    { 0x800,     3, { 0xe0, 0xa0, 0x80, 0x00 } },
    { 0x20ac,    3, { 0xe2, 0x82, 0xac, 0x00 } },
    { 0x20ac,   -1, { 0xe2, 0x02, 0xac, 0x00 } },
    { 0x20ac,   -1, { 0xe2, 0x82, 0x2c, 0x00 } },
    { 0xd800,   -1, { 0xed, 0xa0, 0x80, 0x00 } },
    { 0xd7ff,    3, { 0xed, 0x9f, 0xbf, 0x00 } },
    { 0xffff,    3, { 0xef, 0xbf, 0xbf, 0x00 } },
    { 0x10000,   4, { 0xf0, 0x90, 0x80, 0x80 } },
    { 0x24b62,   4, { 0xf0, 0xa4, 0xad, 0xa2 } },
    { 0x100000,  4, { 0xf4, 0x80, 0x80, 0x80 } },
    { 0x1fffff,  4, { 0xf7, 0xbf, 0xbf, 0xbf } },
    { 0,         1, { 0,    0,    0,    0    } }
};

int decode_utf8(const char *s, int32_t *ch);

int main() {
    test_case *p = &cases[0];
    while (1) {
        int32_t ch, len;
        len = decode_utf8(p->buf, &ch);
        if (len == p->len && ch == p->ch) {
            printf("[PASS] %x %d\n", ch, len);
        }
        else {
            printf("[FAIL] %x/%x %d/%d\n", p->ch, ch,
                    p->len, len);
        }
        if (!p->ch) break;
        p++;
    }
    return 0;
}
